name: Build and Release Litecoin Core

on:
  pull_request:
  push:
    branches:
      - "**"
  workflow_dispatch:

concurrency:
  group: build-release-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  drivechain-functional-tests:
    name: Drivechain functional tests (non-master only)
    if: >
      (github.event_name == 'push' && github.ref_name != 'master') ||
      (github.event_name == 'pull_request' && github.base_ref != 'master')
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: install Linux deps (tests)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libtool \
            autotools-dev \
            automake \
            pkg-config \
            bsdmainutils \
            curl \
            python3 \
            python3-pip \
            libevent-dev \
            libfmt-dev \
            libboost-program-options-dev \
            libboost-system-dev \
            libboost-filesystem-dev \
            libboost-thread-dev \
            libboost-chrono-dev \
            libboost-test-dev \
            libdb++-dev

      - name: Install Python deps for functional tests
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install blake3

          # litecoin_scrypt: prefer in-tree module if present, else PyPI
          if [ -d "test/functional/litecoin_scrypt" ] || [ -f "test/functional/litecoin_scrypt/setup.py" ] || [ -f "test/functional/litecoin_scrypt/pyproject.toml" ]; then
            python3 -m pip install ./test/functional/litecoin_scrypt
          elif [ -d "test/functional/test_framework/litecoin_scrypt" ] || [ -f "test/functional/test_framework/litecoin_scrypt/setup.py" ] || [ -f "test/functional/test_framework/litecoin_scrypt/pyproject.toml" ]; then
            python3 -m pip install ./test/functional/test_framework/litecoin_scrypt
          else
            python3 -m pip install litecoin_scrypt
          fi

      - name: autogen
        run: ./autogen.sh

      - name: configure (wallet enabled; allow non-4.8 BDB on CI)
        env:
          CXXFLAGS: "-pthread"
          LDFLAGS: "-pthread"
          LIBS: "-pthread"
        run: |
          ./configure \
            --without-gui \
            --disable-bench \
            --with-incompatible-bdb

      - name: build
        run: make -j4

      - name: Run drivechain functional tests
        env:
          LC_ALL: C
        run: |
          python3 test/functional/feature_drivechain_activation.py
          python3 test/functional/feature_drivechain_state.py

  build-linux:
    name: Build Linux binaries
    runs-on: ubuntu-22.04

    permissions:
      contents: write

    steps:
      - name: install Linux deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libtool \
            autotools-dev \
            automake \
            pkg-config \
            bsdmainutils \
            curl \
            libevent-dev \
            libboost-dev \
            qtbase5-dev qttools5-dev qttools5-dev-tools qtwayland5 \
            python3

      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Restore cached dependencies
        uses: actions/cache/restore@v4
        with:
          path: ./depends
          key: linux-py311-${{ hashFiles('depends/packages/**') }}

      - name: download dependencies
        run: make -C ./depends download-linux

      - name: build dependencies
        run: make -C ./depends -j4 PYTHON=python3.11

      - name: Cache dependencies
        uses: actions/cache/save@v4
        with:
          path: ./depends
          key: linux-py311-${{ hashFiles('depends/packages/**') }}

      - name: autogen
        run: ./autogen.sh

      - name: configure
        run: |
          CONFIG_SITE=$PWD/depends/x86_64-pc-linux-gnu/share/config.site \
          ./configure --with-gui=qt5 --disable-bench --disable-tests

      - name: build
        run: make -j4

      - name: "Set environment variables: version number"
        shell: bash
        run: |
          LITECOIN_CORE_VERSION=$(grep -E '^AC_INIT' configure.ac | sed -E 's/.*\[[^]]*\], \[([^]]*)\].*/\1/')
          echo "LITECOIN_CORE_VERSION=$LITECOIN_CORE_VERSION" >> "$GITHUB_ENV"
          echo "SHORT_SHA=${GITHUB_SHA::12}" >> "$GITHUB_ENV"

      - name: Rename artifacts before upload
        run: |
          mkdir -p artifacts/qt
          cp src/litecoind artifacts/
          cp src/litecoin-cli artifacts/
          cp src/litecoin-tx artifacts/
          cp src/qt/litecoin-qt artifacts/qt/

      - uses: actions/upload-artifact@v4
        with:
          name: litecoin-core-${{ env.LITECOIN_CORE_VERSION }}-${{ env.SHORT_SHA }}-x86_64-unknown-linux-gnu
          if-no-files-found: error
          path: |
            artifacts/litecoind
            artifacts/litecoin-cli
            artifacts/litecoin-tx
            artifacts/qt/litecoin-qt

      - name: Create GitHub Release
        if: github.event_name == 'push' && github.ref_name == 'master'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ env.LITECOIN_CORE_VERSION }}-master-${{ env.SHORT_SHA }}
          release_name: Litecoin Core v${{ env.LITECOIN_CORE_VERSION }} (Linux x86_64) - master ${{ env.SHORT_SHA }}
          draft: false
          prerelease: true

      - name: Upload litecoind
        if: github.event_name == 'push' && github.ref_name == 'master'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/litecoind
          asset_name: litecoind-v${{ env.LITECOIN_CORE_VERSION }}-${{ env.SHORT_SHA }}-x86_64-unknown-linux-gnu
          asset_content_type: application/octet-stream

      - name: Upload litecoin-cli
        if: github.event_name == 'push' && github.ref_name == 'master'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/litecoin-cli
          asset_name: litecoin-cli-v${{ env.LITECOIN_CORE_VERSION }}-${{ env.SHORT_SHA }}-x86_64-unknown-linux-gnu
          asset_content_type: application/octet-stream

      - name: Upload litecoin-tx
        if: github.event_name == 'push' && github.ref_name == 'master'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/litecoin-tx
          asset_name: litecoin-tx-v${{ env.LITECOIN_CORE_VERSION }}-${{ env.SHORT_SHA }}-x86_64-unknown-linux-gnu
          asset_content_type: application/octet-stream

      - name: Upload litecoin-qt
        if: github.event_name == 'push' && github.ref_name == 'master'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/qt/litecoin-qt
          asset_name: litecoin-qt-v${{ env.LITECOIN_CORE_VERSION }}-${{ env.SHORT_SHA }}-x86_64-unknown-linux-gnu
          asset_content_type: application/octet-stream
